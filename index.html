<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>刷题宝 Ultimate (多学科+断点续传)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: -apple-system, "Microsoft YaHei", sans-serif; -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .option-card:active { transform: scale(0.98); background-color: #f3f4f6; }
        .subject-card { background: linear-gradient(135deg, #ffffff 0%, #f9fafb 100%); }
        /* 进度条动画 */
        .progress-bar { transition: width 0.3s ease; }
    </style>
</head>
<body class="bg-gray-100 h-screen flex flex-col max-w-lg mx-auto shadow-2xl bg-white text-gray-800">

    <!-- 顶部导航 -->
    <header class="flex-none bg-white p-4 border-b flex justify-between items-center shadow-sm z-20">
        <div class="font-bold text-lg flex items-center gap-2 cursor-pointer" onclick="app.goHome()">
            <div class="w-8 h-8 bg-indigo-600 text-white rounded-lg flex items-center justify-center">
                <i class="fa-solid fa-layer-group"></i>
            </div>
            <div class="leading-tight">
                <div>刷题宝 <span class="text-[10px] bg-yellow-100 text-yellow-700 px-1 rounded ml-1">Ultimate</span></div>
            </div>
        </div>
        <!-- 面包屑/状态 -->
        <div class="text-xs text-gray-500 font-medium truncate max-w-[150px]" id="header-status">
            学科列表
        </div>
    </header>

    <!-- 主内容区 -->
    <main class="flex-1 overflow-y-auto relative no-scrollbar bg-gray-50" id="main-container">
        <div id="loading" class="flex flex-col items-center justify-center h-full text-gray-400">
            <i class="fa-solid fa-circle-notch fa-spin text-3xl mb-3 text-indigo-500"></i>
            <p class="text-sm">资源加载中...</p>
            <p class="text-xs text-red-400 mt-4 hidden" id="loading-hint">请使用 http-server 或 live-server 运行</p>
        </div>
    </main>

    <!-- 底部栏 (答题时显示) -->
    <footer id="quiz-footer" class="flex-none bg-white border-t p-3 hidden shadow-[0_-5px_15px_rgba(0,0,0,0.05)] z-20">
        <div class="w-full bg-gray-200 h-1 rounded-full mb-3 overflow-hidden">
            <div id="progress-bar" class="bg-indigo-500 h-full progress-bar" style="width: 0%"></div>
        </div>
        <div class="flex justify-between items-center gap-3">
            <button onclick="app.prevQuestion()" class="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded-lg text-sm font-medium">上一题</button>
            <div class="text-sm font-bold text-gray-700"><span id="current-idx">1</span> / <span id="total-count">10</span></div>
            <div id="action-btn-area"></div>
        </div>
    </footer>

    <script>
        const DATA_DIR = './data';

        const app = {
            data: {
                subjects: [],
                chapters: [],
                userData: { mistakes: [] },
                
                // 运行状态
                currentSubject: null,
                currentQuestions: [],
                currentIndex: 0,
                currentMode: 'subjects', // subjects, chapters, quiz, mistake
                currentTitle: '',
                
                // 单题状态
                currentAnswer: [],
                isSubmitted: false
            },

            async init() {
                setTimeout(() => document.getElementById('loading-hint')?.classList.remove('hidden'), 3000);
                this.loadLocalData();
                await this.loadSubjects();
            },

            // --- 数据持久化 (存档/读档/错题) ---

            loadLocalData() {
                const s = localStorage.getItem('quiz_ultimate_data');
                if(s) try { this.data.userData = JSON.parse(s); } catch(e){}
            },

            saveLocalData() {
                localStorage.setItem('quiz_ultimate_data', JSON.stringify(this.data.userData));
            },

            // 保存进度 (每次渲染题目时调用)
            saveSession() {
                if (this.data.currentMode === 'subjects' || this.data.currentMode === 'chapters') return;
                
                const session = {
                    mode: this.data.currentMode,
                    subject: this.data.currentSubject, // 保存学科信息
                    title: this.data.currentTitle,
                    questions: this.data.currentQuestions,
                    index: this.data.currentIndex,
                    timestamp: Date.now()
                };
                localStorage.setItem('quiz_resume_session', JSON.stringify(session));
            },

            loadSession() {
                try {
                    const saved = localStorage.getItem('quiz_resume_session');
                    return saved ? JSON.parse(saved) : null;
                } catch { return null; }
            },

            clearSession() {
                localStorage.removeItem('quiz_resume_session');
            },

            // --- 加载逻辑 ---

            async loadSubjects() {
                try {
                    const res = await fetch(`${DATA_DIR}/subjects.json?t=${Date.now()}`);
                    if (!res.ok) {
                        this.renderEmpty("未检测到学科数据。<br>请运行 manage_data.py 导入题目。");
                        return;
                    }
                    this.data.subjects = await res.json();
                    this.renderSubjectList();
                } catch (e) {
                    this.renderEmpty("加载失败：" + e.message);
                }
            },

            async loadChapters(subject) {
                this.data.currentSubject = subject;
                this.renderLoading();
                try {
                    const res = await fetch(`${DATA_DIR}/${subject.dir}/index.json?t=${Date.now()}`);
                    if (!res.ok) throw new Error("无章节数据");
                    this.data.chapters = await res.json();
                    this.renderChapterList();
                } catch (e) {
                    this.data.chapters = [];
                    this.renderChapterList(); 
                }
            },

            async loadQuiz(chapterFile, title) {
                this.clearSession(); // 新开一局，清除旧进度
                this.renderLoading();
                try {
                    const res = await fetch(`${DATA_DIR}/${this.data.currentSubject.dir}/${chapterFile}?t=${Date.now()}`);
                    const data = await res.json();
                    const qList = Array.isArray(data) ? data : (data.questions || []);
                    if(qList.length === 0) throw new Error("空章节");
                    
                    this.startQuiz(qList, title, 'quiz');
                } catch(e) {
                    alert("加载失败: " + e.message);
                    this.renderChapterList();
                }
            },

            // --- 界面渲染 ---

            renderSubjectList() {
                this.data.currentMode = 'subjects';
                this.data.currentSubject = null;
                document.getElementById('quiz-footer').classList.add('hidden');
                document.getElementById('header-status').innerText = '学科列表';

                const resumeData = this.loadSession();
                const container = document.getElementById('main-container');
                
                let html = `<div class="p-4 space-y-5 animate-[fadeIn_0.3s]">`;

                // 1. 断点续传卡片 (如果有进度)
                if (resumeData && resumeData.index < resumeData.questions.length) {
                    html += `
                        <div onclick="app.resumeQuiz()" class="bg-gradient-to-r from-indigo-600 to-purple-600 rounded-xl p-4 shadow-lg text-white cursor-pointer relative overflow-hidden group">
                            <div class="relative z-10 flex justify-between items-center">
                                <div>
                                    <div class="text-xs text-indigo-200 mb-1 font-bold flex items-center gap-1">
                                        <i class="fa-solid fa-clock-rotate-left"></i> 继续上次练习
                                    </div>
                                    <h3 class="text-lg font-bold truncate max-w-[200px]">${resumeData.title}</h3>
                                    <p class="text-sm opacity-90 mt-1">进度: ${resumeData.index + 1} / ${resumeData.questions.length}</p>
                                </div>
                                <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center group-hover:bg-white/30 transition-colors">
                                    <i class="fa-solid fa-play text-sm"></i>
                                </div>
                            </div>
                        </div>
                    `;
                }

                // 2. 错题本入口
                const mistakesCount = this.data.userData.mistakes.length;
                html += `
                    <div onclick="app.startMistakeMode()" class="bg-white rounded-xl p-4 shadow-sm border border-red-100 flex items-center justify-between cursor-pointer active:bg-red-50">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 rounded-full bg-red-100 text-red-500 flex items-center justify-center text-xl">
                                <i class="fa-solid fa-book-open"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-gray-800">错题本</h3>
                                <p class="text-xs text-gray-500 mt-1">
                                    ${mistakesCount > 0 ? `共 <span class="text-red-500 font-bold">${mistakesCount}</span> 题待复习` : '暂无错题'}
                                </p>
                            </div>
                        </div>
                        <i class="fa-solid fa-chevron-right text-gray-300"></i>
                    </div>
                `;

                // 3. 学科列表
                html += `<div><h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3 px-1">学科选择</h3><div class="grid grid-cols-1 gap-3">`;
                
                if (this.data.subjects.length === 0) {
                    html += `<div class="p-8 text-center border-2 border-dashed rounded-xl text-gray-400 text-sm">暂无数据<br>请运行 manage_data.py</div>`;
                }

                this.data.subjects.forEach(sub => {
                    html += `
                        <div onclick='app.loadChapters(${JSON.stringify(sub)})' class="subject-card p-4 rounded-xl border border-gray-100 shadow-sm flex items-center justify-between cursor-pointer active:border-indigo-300">
                            <div class="flex items-center gap-4">
                                <div class="w-12 h-12 rounded-xl bg-gray-50 text-gray-600 flex items-center justify-center text-xl">
                                    <i class="fa-solid fa-folder"></i>
                                </div>
                                <div>
                                    <h3 class="font-bold text-gray-800 text-lg">${sub.name}</h3>
                                    <p class="text-xs text-gray-400">点击查看章节</p>
                                </div>
                            </div>
                            <i class="fa-solid fa-chevron-right text-gray-300"></i>
                        </div>
                    `;
                });

                html += `</div></div></div>`;
                container.innerHTML = html;
            },

            renderChapterList() {
                this.data.currentMode = 'chapters';
                const subName = this.data.currentSubject.name;
                document.getElementById('header-status').innerHTML = `<span onclick="app.renderSubjectList()" class="cursor-pointer hover:text-indigo-600">学科</span> > ${subName}`;
                
                const container = document.getElementById('main-container');
                let html = `<div class="p-4 space-y-4 animate-[fadeIn_0.2s]">`;
                
                html += `<div class="flex items-center gap-2 text-xl font-bold text-gray-800"><i class="fa-solid fa-folder-open text-indigo-500"></i> ${subName}</div>`;

                if (this.data.chapters.length === 0) {
                    html += `<div class="text-center py-10 text-gray-400">该学科下暂无章节</div>`;
                } else {
                    html += `<div class="space-y-3">`;
                    this.data.chapters.forEach(ch => {
                         html += `
                            <div onclick="app.loadQuiz('${ch.file}', '${ch.title}')" class="bg-white p-4 rounded-xl border border-gray-100 shadow-sm flex items-center justify-between active:bg-gray-50 cursor-pointer">
                                <div class="flex items-center gap-3">
                                    <div class="w-8 h-8 rounded-full bg-indigo-50 text-indigo-600 flex items-center justify-center text-xs font-bold">
                                        ${ch.title.match(/\d+/) ? ch.title.match(/\d+/)[0] : 'Q'}
                                    </div>
                                    <div>
                                        <div class="font-bold text-gray-700">${ch.title}</div>
                                        <div class="text-xs text-gray-400">${ch.count} 题</div>
                                    </div>
                                </div>
                                <i class="fa-solid fa-play text-gray-200 text-xs"></i>
                            </div>
                        `;
                    });
                    html += `</div>`;
                }
                html += `</div>`;
                container.innerHTML = html;
            },

            // --- 答题逻辑 ---

            resumeQuiz() {
                const session = this.loadSession();
                if (!session) { alert("进度已失效"); this.renderSubjectList(); return; }
                
                // 恢复上下文
                this.data.currentSubject = session.subject;
                this.data.currentTitle = session.title;
                this.data.currentMode = session.mode;
                
                this.startQuiz(session.questions, session.title, session.mode, true);
                this.data.currentIndex = session.index;
                this.renderQuestion();
            },

            startMistakeMode() {
                if (this.data.userData.mistakes.length === 0) { alert("没有错题！"); return; }
                this.clearSession();
                this.startQuiz(this.data.userData.mistakes, "错题突击", 'mistake');
            },

            startQuiz(questions, title, mode, isResume=false) {
                this.data.currentQuestions = questions;
                this.data.currentMode = mode;
                this.data.currentTitle = title;
                
                if (!isResume) this.data.currentIndex = 0;
                
                document.getElementById('header-status').innerText = title;
                document.getElementById('quiz-footer').classList.remove('hidden');
                
                this.resetQuestionState();
                if(!isResume) this.renderQuestion(); // Resume会在恢复index后渲染
            },

            resetQuestionState() {
                this.data.currentAnswer = [];
                this.data.isSubmitted = false;
            },

            renderQuestion() {
                this.saveSession(); // 关键：每次渲染都自动保存进度

                const q = this.data.currentQuestions[this.data.currentIndex];
                const total = this.data.currentQuestions.length;
                const container = document.getElementById('main-container');
                const isMulti = q.type && (q.type.includes('多') || q.answer.length > 1);

                // 进度条
                const pct = ((this.data.currentIndex + 1) / total) * 100;
                document.getElementById('progress-bar').style.width = `${pct}%`;
                document.getElementById('current-idx').innerText = this.data.currentIndex + 1;
                document.getElementById('total-count').innerText = total;

                let html = `
                    <div class="p-5 pb-24 min-h-full bg-white animate-[fadeIn_0.2s]">
                        <div class="flex items-center gap-2 mb-4">
                            <span class="px-2 py-0.5 rounded text-xs font-bold ${isMulti ? 'bg-purple-100 text-purple-700' : 'bg-blue-100 text-blue-700'}">
                                ${q.type || (isMulti ? '多选题' : '单选题')}
                            </span>
                            ${this.data.currentMode === 'mistake' ? '<span class="px-2 py-0.5 rounded text-xs font-bold bg-red-100 text-red-600">复习</span>' : ''}
                        </div>
                        <h2 class="text-lg font-bold text-gray-800 leading-relaxed mb-6 select-none">${q.question}</h2>
                        <div class="space-y-3">
                `;

                const options = q.options || {};
                Object.keys(options).sort().forEach(key => {
                    const val = options[key];
                    let cls = "option-card flex items-start gap-3 p-4 rounded-xl border-2 cursor-pointer transition-all ";
                    let icon = `<div class="w-6 h-6 rounded-full border-2 border-gray-300 text-gray-400 flex items-center justify-center text-xs font-bold">${key}</div>`;
                    
                    const isSel = this.data.currentAnswer.includes(key);
                    const isRight = q.answer.includes(key);

                    if (this.data.isSubmitted) {
                        if (isRight) { cls += "bg-green-50 border-green-500 text-green-800"; icon=`<div class="w-6 h-6 rounded-full bg-green-500 text-white flex items-center justify-center text-xs"><i class="fa-solid fa-check"></i></div>`; }
                        else if (isSel && !isRight) { cls += "bg-red-50 border-red-500 text-red-800"; icon=`<div class="w-6 h-6 rounded-full bg-red-500 text-white flex items-center justify-center text-xs"><i class="fa-solid fa-xmark"></i></div>`; }
                        else { cls += "border-gray-100 opacity-50"; }
                    } else {
                        if (isSel) { cls += "bg-indigo-50 border-indigo-500 text-indigo-700"; icon=`<div class="w-6 h-6 rounded-full bg-indigo-500 text-white flex items-center justify-center text-xs font-bold">${key}</div>`; }
                        else { cls += "bg-white border-gray-200 text-gray-700"; }
                    }
                    
                    const click = this.data.isSubmitted ? '' : `onclick="app.toggleOption('${key}', ${isMulti})"`;
                    html += `<div ${click} class="${cls}"><div class="flex-none pt-0.5">${icon}</div><div class="text-sm font-medium leading-6 select-none">${val}</div></div>`;
                });

                html += `</div>`;

                if (this.data.isSubmitted) {
                    const myAns = this.data.currentAnswer.sort().join('');
                    const rightAns = q.answer.sort().join('');
                    const isCorrect = (myAns === rightAns);
                    
                    html += `
                        <div class="mt-6 p-4 rounded-xl ${isCorrect ? 'bg-green-50 text-green-800' : 'bg-red-50 text-red-800'} animate-[slideInUp_0.3s]">
                            <div class="font-bold mb-1 flex items-center gap-2"><i class="fa-solid ${isCorrect?'fa-circle-check':'fa-circle-xmark'}"></i> ${isCorrect?'回答正确':'回答错误'}</div>
                            <div class="text-sm">正确答案：<strong class="text-lg">${q.answer.join(' ')}</strong></div>
                            ${this.data.currentMode === 'mistake' && isCorrect ? `<button onclick="app.removeMistake('${q.id}')" class="mt-3 w-full py-2 bg-white text-green-600 border border-green-200 rounded-lg text-xs font-bold shadow-sm">移除此题</button>` : ''}
                        </div>
                    `;
                }

                html += `</div>`;
                container.innerHTML = html;
                this.renderFooterButtons(isMulti);
            },

            renderFooterButtons(isMulti) {
                const area = document.getElementById('action-btn-area');
                const isLast = this.data.currentIndex === this.data.currentQuestions.length - 1;

                if (!this.data.isSubmitted) {
                    area.innerHTML = isMulti 
                        ? `<button onclick="app.submitAnswer(true)" class="bg-indigo-600 text-white px-5 py-2 rounded-lg font-bold shadow-lg shadow-indigo-200 active:scale-95 transition-transform">确认</button>`
                        : `<span class="text-xs text-gray-400">点击自动判定</span>`;
                } else {
                    area.innerHTML = isLast 
                        ? `<button onclick="app.finishQuiz()" class="bg-gray-800 text-white px-5 py-2 rounded-lg font-bold shadow-lg">完成</button>`
                        : `<button onclick="app.nextQuestion()" class="bg-indigo-600 text-white px-5 py-2 rounded-lg font-bold shadow-lg shadow-indigo-200 animate-pulse">下一题</button>`;
                }
            },

            toggleOption(key, isMulti) {
                if (isMulti) {
                    this.data.currentAnswer = this.data.currentAnswer.includes(key) ? this.data.currentAnswer.filter(k=>k!==key) : [...this.data.currentAnswer, key];
                    this.renderQuestion();
                } else {
                    this.data.currentAnswer = [key];
                    this.submitAnswer(false);
                }
            },

            submitAnswer(manual) {
                if(this.data.currentAnswer.length===0 && manual) { alert("请选择"); return; }
                const q = this.data.currentQuestions[this.data.currentIndex];
                const isRight = this.data.currentAnswer.sort().join('') === q.answer.sort().join('');
                
                this.data.isSubmitted = true;
                if(!isRight) this.addToMistakes(q);
                this.renderQuestion();
            },

            nextQuestion() {
                if(this.data.currentIndex < this.data.currentQuestions.length-1) {
                    this.data.currentIndex++;
                    this.resetQuestionState();
                    this.renderQuestion();
                }
            },
            
            prevQuestion() {
                if(this.data.currentIndex > 0) {
                    this.data.currentIndex--;
                    this.resetQuestionState(); // 允许重做
                    this.renderQuestion();
                }
            },

            finishQuiz() {
                this.clearSession();
                if (this.data.currentMode === 'mistake') {
                     this.renderSubjectList();
                } else {
                     this.renderChapterList();
                }
            },

            addToMistakes(q) {
                if(!this.data.userData.mistakes.find(i=>i.id===q.id)) {
                    q._sub = this.data.currentSubject?.name; // 记录来源
                    this.data.userData.mistakes.push(q);
                    this.saveLocalData();
                }
            },
            
            removeMistake(id) {
                this.data.userData.mistakes = this.data.userData.mistakes.filter(i=>i.id!==id);
                this.saveLocalData();
            },

            goHome() {
                this.renderSubjectList();
            },
            
            renderLoading() { document.getElementById('main-container').innerHTML = `<div class="flex h-full items-center justify-center"><i class="fa-solid fa-spinner fa-spin text-2xl text-indigo-500"></i></div>`; },
            renderEmpty(msg) { document.getElementById('main-container').innerHTML = `<div class="h-full flex flex-col items-center justify-center text-center p-6 text-gray-400"><i class="fa-solid fa-folder-open text-4xl mb-4"></i><p class="text-sm">${msg}</p></div>`; }
        };

        app.init();
    </script>
</body>
</html>