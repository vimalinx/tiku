<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>刷题宝 Ultimate (模拟考版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { box-sizing: border-box; }
        body { font-family: -apple-system, "Microsoft YaHei", sans-serif; -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        /* Watermark Style */
        .watermark-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            pointer-events: none;
            z-index: 0; /* Bottom layer */
            overflow: hidden;
            display: grid;
            grid-template-columns: repeat(2, 1fr); /* Strictly 2 columns */
            gap: 0;
            padding: 0;
            opacity: 0.15; 
        }
        .watermark-item {
            display: flex;
            flex-direction: column; /* Stack name and ID */
            align-items: center;
            justify-content: center;
            transform: rotate(-25deg);
            color: #000;
            font-size: 14px; /* Slightly larger */
            font-weight: 500;
            user-select: none;
            text-align: center;
            line-height: 1.5;
            height: 180px; /* Fixed height for vertical spacing */
        }

        /* Custom UI Elements from Image */
        .quiz-option-card {
            background: #fff; /* Opaque white background */
            border: 1px solid #f0f0f0;
            border-radius: 4px;
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            align-items: flex-start;
            transition: background-color 0.2s;
            position: relative;
            z-index: 1; /* Above watermark */
        }
        .quiz-option-card.selected {
            background-color: #e6f7ff;
            border-color: #91d5ff;
        }
        .quiz-option-card.correct {
            background-color: #f6ffed;
            border-color: #b7eb8f;
        }
        .quiz-option-card.wrong {
            background-color: #fff1f0;
            border-color: #ffa39e;
        }

        .footer-next-btn {
            background-color: #3b82f6; /* Blue */
            color: white;
            font-weight: 500;
        }
        
        .progress-track {
            height: 4px;
            background-color: #e5e7eb;
            border-radius: 2px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background-color: #3b82f6;
            transition: width 0.3s ease;
        }

        /* Hide default UI when in Quiz Mode */
        body.quiz-mode {
            background-color: #fff !important; /* White background for quiz */
        }
        body.quiz-mode .app-layout {
            display: none;
        }
        body.quiz-mode #quiz-ui {
            display: flex;
        }
        #quiz-ui {
            display: none;
            flex-direction: column;
            height: 100vh;
            background-color: transparent; /* Transparent to let body/watermark show */
            position: relative;
            z-index: 1; /* Above watermark */
        }

        /* Default Layout styles (preserved for non-quiz mode) */
        .app-layout { display: flex; height: 100vh; overflow: hidden; }
        .sidebar { width: 300px; background: white; border-right: 1px solid #e5e7eb; display: none; flex-direction: column; }
        @media (min-width: 1024px) { .sidebar { display: flex; } }
        .main-content { flex: 1; display: flex; flex-direction: column; background: #f9fafb; overflow: hidden; }
        
        /* Mobile handling for default layout */
        @media (max-width: 1024px) {
            .app-layout { display: block; overflow-y: auto; }
            .sidebar { display: none; }
            .main-content { height: auto; }
        }

        .animate-fade-in { animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-gray-100 h-screen text-gray-800 text-[14px]">

    <!-- Watermark Container (Always present but visible based on context) -->
    <div class="watermark-container" id="watermark-layer"></div>

    <!-- 1. Default App Layout (Subject Selection, Chapter Selection) -->
    <div class="app-layout" id="default-ui">
        <!-- Sidebar (Desktop) -->
        <aside class="sidebar">
            <div class="p-5 border-b border-gray-100 font-bold text-base flex items-center gap-2">
                <i class="fa-solid fa-layer-group text-indigo-600"></i> 刷题宝 Ultimate
            </div>
            <div class="flex-1 overflow-y-auto p-4 space-y-4">
                 <div onclick="app.renderSubjectList()" class="cursor-pointer p-3 rounded hover:bg-gray-50 flex items-center gap-3 text-gray-700">
                    <i class="fa-solid fa-home"></i> 回到首页
                </div>
                 <div onclick="app.toggleSettings()" class="cursor-pointer p-3 rounded hover:bg-gray-50 flex items-center gap-3 text-gray-700">
                    <i class="fa-solid fa-user-cog"></i> 个人设置
                </div>
                <div id="sidebar-content"></div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="p-4 bg-white border-b border-gray-200 flex justify-between items-center sticky top-0 z-20">
                <div id="header-title" class="font-bold text-base">刷题宝</div>
                <div class="flex items-center gap-3" onclick="app.toggleSettings()">
                    <div id="user-info" class="text-xs text-gray-500 cursor-pointer">[姓名] ([学号])</div>
                    <i class="fa-solid fa-cog text-gray-400 cursor-pointer text-base"></i>
                </div>
            </div>
            
            <div id="main-container" class="flex-1 overflow-y-auto p-4 pb-20">
                <!-- Dynamic Content Here -->
            </div>
        </main>
    </div>

    <!-- 2. Quiz Mode UI (Replicating the Image) -->
    <div id="quiz-ui" class="bg-white">
        <!-- Header -->
        <header class="h-12 flex items-center px-4 bg-white border-b border-gray-100 flex-shrink-0 z-20 relative">
            <button onclick="app.exitQuiz()" class="w-10 h-10 flex items-center justify-start text-gray-600">
                <i class="fa-solid fa-chevron-left text-lg"></i>
            </button>
            <div class="flex-1 text-center font-medium text-[16px] text-gray-800">[姓名] ([学号])</div>
            <div class="w-10"></div> <!-- Spacer -->
        </header>

        <!-- Info Bar -->
        <div class="flex items-center justify-between px-4 py-3 bg-white z-20 relative">
            <div class="flex items-center gap-1.5 text-gray-600">
                <i class="fa-regular fa-clock text-lg text-gray-400"></i>
                <span id="timer-display" class="text-[15px] font-medium tracking-wide">00' 00"</span>
            </div>
            
            <div class="flex items-center gap-3 flex-1 ml-6 mr-4">
                <span class="text-gray-800 text-[16px] font-medium" id="progress-text">1/10</span>
                <div class="flex-1 progress-track bg-gray-100 rounded-full h-1.5">
                    <div id="progress-bar" class="progress-fill rounded-full" style="width: 0%"></div>
                </div>
            </div>

            <div onclick="app.togglePalette()" class="flex flex-col items-center text-gray-600 cursor-pointer min-w-[40px]">
                <i class="fa-regular fa-newspaper text-xl mb-0.5"></i>
                <span class="text-[11px] font-medium">答题卡</span>
            </div>
        </div>

        <!-- Scrollable Question Area -->
        <div class="flex-1 overflow-y-auto relative z-10" id="quiz-content">
            <div class="p-4 pb-24">
                <!-- Question Type Description -->
                <div class="mb-4">
                    <h2 class="text-[15px] font-bold text-gray-800 mb-1" id="q-type-title">单选题 (共36题，36.0分)</h2>
                    <p class="text-xs text-gray-400 leading-relaxed text-justify" id="q-type-desc">
                        题型说明: 1-36小题，每小题1分，共36分。下列每题给出的四个选项中，只有一个选项是符合题目要求的，请选出正确答案。多选、错选、不选均不得分
                    </p>
                </div>

                <!-- Question Text -->
                <div class="mb-6">
                    <div class="text-[15px] text-gray-800 leading-relaxed font-medium">
                        <span id="q-number">2.</span> <span class="text-gray-500 text-xs font-normal">(1.0分)</span> 
                        <span id="q-text">个人对社会的责任与贡献属于( )</span>
                    </div>
                </div>

                <!-- Options List -->
                <div id="q-options" class="space-y-4">
                    <!-- Options injected here -->
                </div>
            </div>
        </div>

        <!-- Footer Actions -->
        <div class="bg-white border-t border-gray-100 flex items-center px-6 py-3 fixed bottom-0 left-0 w-full z-30" style="padding-bottom: max(12px, env(safe-area-inset-bottom));">
            <div onclick="app.prevQuestion()" class="text-blue-500 text-[15px] font-medium mr-6 cursor-pointer active:opacity-70">
                上一题
            </div>
            <div onclick="app.nextQuestionOrSubmit()" id="next-btn-text" class="flex-1 bg-blue-500 text-white text-[15px] font-medium py-2.5 rounded text-center cursor-pointer active:bg-blue-600 shadow-sm transition-colors">
                下一题
            </div>
        </div>

        <!-- Answer Card Modal (Palette) -->
        <div id="palette-modal" class="fixed inset-0 z-50 hidden bg-black/50" onclick="app.togglePalette()">
            <div class="absolute bottom-0 w-full bg-white rounded-t-2xl p-4 max-h-[70vh] overflow-y-auto" onclick="event.stopPropagation()">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-gray-700">答题卡</h3>
                    <i onclick="app.togglePalette()" class="fa-solid fa-times text-gray-400 p-2"></i>
                </div>
                <div id="palette-grid" class="grid grid-cols-6 gap-3"></div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 z-50 hidden bg-black/50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl w-full max-w-sm p-6 shadow-2xl">
            <h3 class="text-lg font-bold text-gray-800 mb-4">个人信息设置</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">姓名</label>
                    <input type="text" id="setting-name" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all" placeholder="请输入姓名">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">学号</label>
                    <input type="text" id="setting-id" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all" placeholder="请输入学号">
                </div>
            </div>
            <div class="mt-6 flex gap-3">
                <button onclick="app.toggleSettings()" class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 font-medium">取消</button>
                <button onclick="app.saveSettings()" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium">保存</button>
            </div>
        </div>
    </div>

    <script>
        const DATA_DIR = './data';
        
        // Generate Watermark
        function initWatermark(name = "[姓名]", id = "[学号]") {
            const container = document.getElementById('watermark-layer');
            const text = `${name}<br>${id}`;
            let html = '';
            // Create a larger number of items to ensure full coverage
            for(let i=0; i<100; i++) {
                html += `<div class="watermark-item">${text}</div>`;
            }
            container.innerHTML = html;
        }

        const app = {
            data: {
                subjects: [],
                chapters: [],
                currentSubject: null,
                currentQuestions: [],
                currentIndex: 0,
                currentAnswer: [], // current question selected options
                answersMap: {}, // map of question index -> array of selected options
                mistakes: [],
                startTime: null,
                timerInterval: null,
                // User Settings
                userName: "[姓名]",
                userId: "[学号]"
            },

            async init() {
                this.loadSettings();
                initWatermark(this.data.userName, this.data.userId);
                this.updateUserInfoUI();
                await this.loadSubjects();
                // Load persisted data if any
                const saved = localStorage.getItem('tiku_progress');
                if(saved) {
                   try {
                       const parsed = JSON.parse(saved);
                       this.data.mistakes = parsed.mistakes || [];
                   } catch(e){}
                }
            },

            loadSettings() {
                const s = localStorage.getItem('tiku_user_settings');
                if (s) {
                    try {
                        const parsed = JSON.parse(s);
                        this.data.userName = parsed.name || "[姓名]";
                        this.data.userId = parsed.id || "[学号]";
                    } catch(e) {}
                }
            },

            saveSettings() {
                const nameInput = document.getElementById('setting-name').value.trim();
                const idInput = document.getElementById('setting-id').value.trim();
                
                if (nameInput) this.data.userName = nameInput;
                if (idInput) this.data.userId = idInput;

                localStorage.setItem('tiku_user_settings', JSON.stringify({
                    name: this.data.userName,
                    id: this.data.userId
                }));

                this.updateUserInfoUI();
                initWatermark(this.data.userName, this.data.userId);
                this.toggleSettings();
            },

            toggleSettings() {
                const modal = document.getElementById('settings-modal');
                if (modal.classList.contains('hidden')) {
                    // Open
                    document.getElementById('setting-name').value = this.data.userName;
                    document.getElementById('setting-id').value = this.data.userId;
                    modal.classList.remove('hidden');
                } else {
                    // Close
                    modal.classList.add('hidden');
                }
            },

            updateUserInfoUI() {
                const info = `${this.data.userName} (${this.data.userId})`;
                // Update Default Layout Header
                const el1 = document.getElementById('user-info');
                if(el1) el1.innerText = info;
                
                // Update Quiz Layout Header (requires finding the element, as it doesn't have an ID in previous code, need to fix that or use querySelector)
                // In my previous edits, I didn't give the quiz header text a specific ID, it was just inside the div. 
                // Let's rely on a selector or add an ID in a separate step? 
                // Actually, I can target it via the header structure.
                const quizHeaderTitle = document.querySelector('#quiz-ui header .flex-1');
                if(quizHeaderTitle) quizHeaderTitle.innerText = info;
            },

            async loadSubjects() {
                try {
                    const res = await fetch(`${DATA_DIR}/subjects.json`);
                    this.data.subjects = await res.json();
                    this.renderSubjectList();
                } catch(e) {
                    document.getElementById('main-container').innerHTML = `<div class="p-8 text-center text-gray-400">加载失败，请检查 data 目录</div>`;
                }
            },

            async loadChapters(subject) {
                this.data.currentSubject = subject;
                const container = document.getElementById('main-container');
                container.innerHTML = '<div class="p-8 text-center"><i class="fa-solid fa-spinner fa-spin text-blue-500"></i></div>';
                
                try {
                    const res = await fetch(`${DATA_DIR}/${subject.dir}/index.json`);
                    this.data.chapters = await res.json();
                    this.renderChapterList();
                } catch(e) {
                    this.renderChapterList([]); // Empty
                }
            },

            async startQuiz(chapterFile, title) {
                try {
                    const res = await fetch(`${DATA_DIR}/${this.data.currentSubject.dir}/${chapterFile}`);
                    let questions = await res.json();
                    if(questions.questions) questions = questions.questions;
                    
                    this.data.currentQuestions = questions;
                    this.data.currentIndex = 0;
                    this.data.answersMap = {};
                    this.data.startTime = Date.now();
                    
                    this.enterQuizMode();
                    this.startTimer();
                    this.renderQuestion();
                } catch(e) {
                    alert("题目加载失败");
                }
            },

            // --- UI Rendering ---

            renderSubjectList() {
                document.getElementById('header-title').innerText = "学科选择";
                const html = this.data.subjects.map(s => `
                    <div onclick='app.loadChapters(${JSON.stringify(s)})' class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm flex items-center justify-between mb-3 cursor-pointer active:scale-98 transition-transform">
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 rounded-full bg-blue-50 text-blue-500 flex items-center justify-center"><i class="fa-solid fa-book"></i></div>
                            <span class="font-bold text-gray-700">${s.name}</span>
                        </div>
                        <i class="fa-solid fa-chevron-right text-gray-300"></i>
                    </div>
                `).join('');
                document.getElementById('main-container').innerHTML = html;
            },

            renderChapterList() {
                document.getElementById('header-title').innerText = this.data.currentSubject.name;
                const html = `
                    <div onclick="app.renderSubjectList()" class="mb-4 text-blue-500 text-sm flex items-center gap-1 cursor-pointer"><i class="fa-solid fa-arrow-left"></i> 返回学科</div>
                    ${this.data.chapters.map(c => `
                        <div onclick="app.startQuiz('${c.file}', '${c.title}')" class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm flex items-center justify-between mb-3 cursor-pointer">
                            <div>
                                <div class="font-bold text-gray-800 text-sm mb-1">${c.title}</div>
                                <div class="text-xs text-gray-400">共 ${c.count} 题</div>
                            </div>
                            <div class="px-3 py-1 bg-blue-50 text-blue-600 text-xs rounded-full">开始</div>
                        </div>
                    `).join('')}
                `;
                document.getElementById('main-container').innerHTML = html;
            },

            enterQuizMode() {
                document.body.classList.add('quiz-mode');
            },

            exitQuiz() {
                if(confirm("确定退出练习吗？进度将不会保存。")) {
                    document.body.classList.remove('quiz-mode');
                    clearInterval(this.data.timerInterval);
                    this.renderChapterList();
                }
            },

            startTimer() {
                clearInterval(this.data.timerInterval);
                const timerEl = document.getElementById('timer-display');
                let totalSeconds = 40 * 60; // 40 minutes
                
                const updateDisplay = () => {
                    const m = Math.floor(totalSeconds / 60).toString().padStart(2, '0');
                    const s = (totalSeconds % 60).toString().padStart(2, '0');
                    timerEl.innerText = `${m}' ${s}"`;
                    if (totalSeconds <= 0) {
                        clearInterval(this.data.timerInterval);
                        alert("时间到！系统已自动提交。");
                        this.showResult();
                    }
                    totalSeconds--;
                };

                updateDisplay();
                this.data.timerInterval = setInterval(updateDisplay, 1000);
            },

            // --- Core Quiz Logic ---

            renderQuestion() {
                const q = this.data.currentQuestions[this.data.currentIndex];
                const total = this.data.currentQuestions.length;
                
                // 1. Update Progress
                document.getElementById('progress-text').innerText = `${this.data.currentIndex + 1}/${total}`;
                const pct = ((this.data.currentIndex + 1) / total) * 100;
                document.getElementById('progress-bar').style.width = `${pct}%`;

                // 2. Update Header Info
                document.getElementById('q-number').innerText = `${this.data.currentIndex + 1}.`;
                document.getElementById('q-text').innerText = q.question;

                // 3. Update Question Type Info
                const isMulti = q.type === "多选题";
                const typeText = isMulti ? "多选题" : "单选题";
                // Mocking score logic as requested by image style
                const scoreText = isMulti ? "2.0分" : "1.0分"; 
                const totalScore = total * (isMulti ? 2 : 1); // rough estimate
                
                document.getElementById('q-type-title').innerText = `${typeText} (共${total}题，${totalScore}.0分)`;
                document.getElementById('q-type-desc').innerText = isMulti 
                    ? `题型说明: 每小题2分。下列每题给出的选项中，至少有两个选项符合题目要求。多选、少选、错选均不得分。`
                    : `题型说明: 每小题1分。下列每题给出的四个选项中，只有一个选项是符合题目要求的。`;

                // 4. Render Options
                const currentAnswer = this.data.answersMap[this.data.currentIndex] || [];
                // Check if we should show result (if answered)
                // For this UI, let's assume "Practice Mode" where we show result immediately after interaction?
                // Or "Exam Mode"? The image looks like an exam or practice. 
                // Let's implement immediate feedback style similar to common apps:
                // If answered, show color. If not, show plain.
                
                // Wait, typical "Next" button flow implies we select then confirm? 
                // Or instant click?
                // The image shows "Next Question" button. Usually means select -> next. 
                // But let's look at the options. 
                
                const optionsContainer = document.getElementById('q-options');
                let optionsHtml = '';
                
                // Normalize options (handle array or object)
                let opts = q.options;
                // If it's an object {A:..., B:...}
                
                Object.keys(opts).forEach(key => {
                    const val = opts[key];
                    const isSelected = currentAnswer.includes(key);
                    
                    // Style determination
                    // In this specific UI, we just highlight selected. 
                    // Verification happens? The image doesn't explicitly show right/wrong state.
                    // But usually, if it's "Practice", it shows. 
                    // Let's toggle selection state visually first.
                    
                    let cardClass = "quiz-option-card";
                    let letterClass = "font-bold text-gray-700 text-[15px] mr-4 w-6";
                    
                    if (isSelected) {
                        cardClass += " selected";
                        letterClass = "font-bold text-blue-600 text-[15px] mr-4 w-6";
                    }

                    optionsHtml += `
                        <div onclick="app.toggleOption('${key}')" class="${cardClass}">
                            <div class="${letterClass}">${key}</div>
                            <div class="text-gray-700 text-[14px] leading-relaxed pt-0.5">${val}</div>
                        </div>
                    `;
                });
                optionsContainer.innerHTML = optionsHtml;

                // Update Next Button Text
                const nextBtn = document.getElementById('next-btn-text');
                nextBtn.innerText = (this.data.currentIndex === total - 1) ? "提交试卷" : "下一题";
            },

            toggleOption(key) {
                const q = this.data.currentQuestions[this.data.currentIndex];
                const isMulti = q.type === "多选题";
                
                let ans = this.data.answersMap[this.data.currentIndex] || [];
                
                if (isMulti) {
                    if (ans.includes(key)) ans = ans.filter(k => k !== key);
                    else ans.push(key);
                } else {
                    // Single choice: toggle off if same, switch if diff
                    if (ans.includes(key)) ans = []; 
                    else ans = [key];
                }
                
                this.data.answersMap[this.data.currentIndex] = ans;
                this.renderQuestion(); // Re-render to update styles
            },

            nextQuestionOrSubmit() {
                const total = this.data.currentQuestions.length;
                if (this.data.currentIndex < total - 1) {
                    this.data.currentIndex++;
                    this.renderQuestion();
                } else {
                    // Submit
                    if(confirm("确定提交试卷吗？")) {
                        this.showResult();
                    }
                }
            },

            prevQuestion() {
                if (this.data.currentIndex > 0) {
                    this.data.currentIndex--;
                    this.renderQuestion();
                }
            },

            togglePalette() {
                const p = document.getElementById('palette-modal');
                const isOpen = !p.classList.contains('hidden');
                
                if (isOpen) {
                    p.classList.add('hidden');
                } else {
                    // Render Palette Content
                    const grid = document.getElementById('palette-grid');
                    grid.innerHTML = this.data.currentQuestions.map((q, i) => {
                        const isAns = this.data.answersMap[i] && this.data.answersMap[i].length > 0;
                        const isCurrent = i === this.data.currentIndex;
                        let cls = "w-10 h-10 rounded-full flex items-center justify-center text-sm font-bold border ";
                        
                        if (isCurrent) cls += "border-blue-500 text-blue-500 bg-white ring-2 ring-blue-100";
                        else if (isAns) cls += "bg-blue-500 border-blue-500 text-white";
                        else cls += "border-gray-200 text-gray-500 bg-white";
                        
                        return `<div onclick="app.jumpTo(${i})" class="${cls}">${i+1}</div>`;
                    }).join('');
                    
                    p.classList.remove('hidden');
                }
            },
            
            jumpTo(i) {
                this.data.currentIndex = i;
                this.renderQuestion();
                this.togglePalette();
            },

            showResult() {
                alert("考试结束！(结果页面待开发)");
                this.exitQuiz();
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            app.init();
        });
    </script>
</body>
</html>